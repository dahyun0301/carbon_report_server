<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Carbon Emission Upload & Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body { font-family: sans-serif; margin: 20px; }
      form { display: flex; flex-direction: column; gap: 10px; max-width: 400px; }
      label { font-weight: bold; }
      input, button { padding: 8px; font-size: 1rem; }
      .charts { display: flex; gap: 50px; margin-top: 50px; }
      canvas { background: #fafafa; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>íƒ„ì†Œ ë°°ì¶œ ë°ì´í„° ì—…ë¡œë“œ ë° ë¶„ì„</h1>
    <form action="/upload-excel" method="post" enctype="multipart/form-data">
        <!-- 1. ì—‘ì…€ ì—…ë¡œë“œ -->
        <label>ì—‘ì…€ íŒŒì¼ (.xlsx)</label>
        <input type="file" name="file" accept=".xlsx" required />

        <!-- 2. ê¸°ì—…ëª… & ì—…ì¢… -->
        <label>ê¸°ì—…ëª…</label>
        <input type="text" name="company_name" value="{{ company_name }}" placeholder="ê¸°ì—…ëª… ì…ë ¥" required />

        <label>ì—…ì¢…</label>
        <input type="text" name="industry" value="{{ industry }}" placeholder="ì—…ì¢… ì…ë ¥" required />

        <!-- 3. ë¶„ì„ ê¸°ê°„ -->
        <label>ì‹œì‘ ì›”</label>
        <input type="month" name="start" value="{{ start }}" required />

        <label>ì¢…ë£Œ ì›”</label>
        <input type="month" name="end" value="{{ end }}" required />

        <!-- 4. ë°°ì¶œê¶Œ í—ˆìš©ëŸ‰ (quota) -->
        <label>ë°°ì¶œê¶Œ í—ˆìš©ëŸ‰ (kgCOâ‚‚)</label>
        <input type="number" step="0.01" name="quota" value="{{ quota }}" placeholder="ì˜ˆ: 50000" required />

        <!-- 5. ë¶„ì„ ì‹¤í–‰ ë²„íŠ¼ -->
        <button type="submit">ë¶„ì„ ì‹¤í–‰</button>
    </form>

    {% if results and scopes %}
    <div class="charts">
        <canvas id="emissionChart" width="600" height="400"></canvas>
        <canvas id="scopeChart" width="600" height="400"></canvas>
    </div>

    <script>
        // JSON íŒŒì‹±
        let results = [];
        let scopes = [];
        try {
            results = JSON.parse('{{ results | safe }}');
            scopes = JSON.parse('{{ scopes | safe }}');
        } catch (e) {
            console.error('JSON parse error:', e);
        }

        if (results.length > 0 && scopes.length > 0) {
            // ê³µí†µ ë³€ìˆ˜
            const labels = results.map(r => r.month);
            const electricity   = results.map(r => r.electricity);
            const gasoline      = results.map(r => r.gasoline);
            const naturalGas    = results.map(r => r.natural_gas);
            const districtHeat  = results.map(r => r.district_heating);
            const totalEmission = results.map(r => r.total_emission);

            // ë°°ì¶œëŸ‰ ì°¨íŠ¸
            new Chart(document.getElementById('emissionChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Electricity (kWh)', data: electricity },
                        { label: 'Gasoline (L)', data: gasoline },
                        { label: 'Natural Gas (mÂ³)', data: naturalGas },
                        { label: 'District Heating (GJ)', data: districtHeat },
                        {
                            label: 'Total Emission (kgCOâ‚‚)',
                            data: totalEmission,
                            type: 'line',
                            borderColor: 'rgba(0,0,0,0.7)',
                            backgroundColor: 'transparent',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { beginAtZero: true, position: 'left' },
                        y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false } }
                    }
                }
            });

            // Scope ì°¨íŠ¸
            const scopeLabels = scopes.map(s => s.month);
            const scope1 = scopes.map(s => s.scope1);
            const scope2 = scopes.map(s => s.scope2);
            new Chart(document.getElementById('scopeChart').getContext('2d'), {
                type: 'bar',
                data: { labels: scopeLabels, datasets: [
                    { label: 'Scope 1 (kgCOâ‚‚)', data: scope1 },
                    { label: 'Scope 2 (kgCOâ‚‚)', data: scope2 }
                ]},
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }
    </script>

    <!-- 6. ë³´ê³ ì„œ ë³´ê¸° ë²„íŠ¼ -->
    <form action="/report" method="get" style="margin-top:20px;">
        <input type="hidden" name="company_name" value="{{ company_name }}" />
        <input type="hidden" name="industry"     value="{{ industry }}"     />
        <input type="hidden" name="start"        value="{{ start }}"        />
        <input type="hidden" name="end"          value="{{ end }}"          />
        <input type="hidden" name="quota"        value="{{ quota }}"        />
        <button type="submit">ğŸ“„ ë³´ê³ ì„œ ë³´ê¸°</button>
    </form>
    {% endif %}
</body>
</html>