<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Carbon Emission Upload & Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body { font-family: sans-serif; margin: 20px; }
      form { display: flex; flex-direction: column; gap: 10px; max-width: 400px; }
      label { font-weight: bold; }
      input, button { padding: 8px; font-size: 1rem; }
      .charts { display: flex; gap: 50px; margin-top: 50px; }
      canvas { background: #fafafa; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>탄소 배출 데이터 업로드 및 분석</h1>
    <form action="/upload-excel" method="post" enctype="multipart/form-data">
        <!-- 1. 엑셀 업로드 -->
        <label>엑셀 파일 (.xlsx)</label>
        <input type="file" name="file" accept=".xlsx" required />

        <!-- 2. 기업명 & 업종 -->
        <label>기업명</label>
        <input type="text" name="company_name" value="{{ company_name }}" placeholder="기업명 입력" required />

        <label>업종</label>
        <input type="text" name="industry" value="{{ industry }}" placeholder="업종 입력" required />

        <!-- 3. 분석 기간 -->
        <label>시작 월</label>
        <input type="month" name="start" value="{{ start }}" required />

        <label>종료 월</label>
        <input type="month" name="end" value="{{ end }}" required />

        <!-- 4. 배출권 허용량 (quota) -->
        <label>배출권 허용량 (kgCO₂)</label>
        <input type="number" step="0.01" name="quota" value="{{ quota }}" placeholder="예: 50000" required />

        <!-- 5. 분석 실행 버튼 -->
        <button type="submit">분석 실행</button>
    </form>

    {% if results and scopes %}
    <div class="charts">
        <canvas id="emissionChart" width="600" height="400"></canvas>
        <canvas id="scopeChart" width="600" height="400"></canvas>
    </div>

    <script>
        // JSON 파싱
        let results = [];
        let scopes = [];
        try {
            results = JSON.parse('{{ results | safe }}');
            scopes = JSON.parse('{{ scopes | safe }}');
        } catch (e) {
            console.error('JSON parse error:', e);
        }

        if (results.length > 0 && scopes.length > 0) {
            // 공통 변수
            const labels = results.map(r => r.month);
            const electricity   = results.map(r => r.electricity);
            const gasoline      = results.map(r => r.gasoline);
            const naturalGas    = results.map(r => r.natural_gas);
            const districtHeat  = results.map(r => r.district_heating);
            const totalEmission = results.map(r => r.total_emission);

            // 배출량 차트
            new Chart(document.getElementById('emissionChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Electricity (kWh)', data: electricity },
                        { label: 'Gasoline (L)', data: gasoline },
                        { label: 'Natural Gas (m³)', data: naturalGas },
                        { label: 'District Heating (GJ)', data: districtHeat },
                        {
                            label: 'Total Emission (kgCO₂)',
                            data: totalEmission,
                            type: 'line',
                            borderColor: 'rgba(0,0,0,0.7)',
                            backgroundColor: 'transparent',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { beginAtZero: true, position: 'left' },
                        y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false } }
                    }
                }
            });

            // Scope 차트
            const scopeLabels = scopes.map(s => s.month);
            const scope1 = scopes.map(s => s.scope1);
            const scope2 = scopes.map(s => s.scope2);
            new Chart(document.getElementById('scopeChart').getContext('2d'), {
                type: 'bar',
                data: { labels: scopeLabels, datasets: [
                    { label: 'Scope 1 (kgCO₂)', data: scope1 },
                    { label: 'Scope 2 (kgCO₂)', data: scope2 }
                ]},
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }
    </script>

    <!-- 6. 보고서 보기 버튼 -->
    <form action="/report" method="get" style="margin-top:20px;">
        <input type="hidden" name="company_name" value="{{ company_name }}" />
        <input type="hidden" name="industry"     value="{{ industry }}"     />
        <input type="hidden" name="start"        value="{{ start }}"        />
        <input type="hidden" name="end"          value="{{ end }}"          />
        <input type="hidden" name="quota"        value="{{ quota }}"        />
        <button type="submit">📄 보고서 보기</button>
    </form>
    {% endif %}
</body>
</html>